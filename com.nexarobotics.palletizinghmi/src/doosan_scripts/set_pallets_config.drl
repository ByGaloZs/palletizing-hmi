import sys

# -------------------------------
# MAPA DE GPRS PARA EL PLC
# -------------------------------

# BOOL GPR (salidas hacia PLC)
GPR_BOOL_LEFT_ENABLED   = 0
GPR_BOOL_RIGHT_ENABLED  = 1

# INT GPR (salidas hacia PLC)
GPR_INT_SIDE_CODE       = 0
GPR_INT_LEFT_LAYER      = 1
GPR_INT_LEFT_SLOT       = 2
GPR_INT_RIGHT_LAYER     = 3
GPR_INT_RIGHT_SLOT      = 4


def send_pallet_config_to_plc(
    side_code,
    left_enabled,
    left_layer,
    left_slot,
    right_enabled,
    right_layer,
    right_slot,
):
    """
    Envía la configuración del pallet al PLC.
    Los parámetros ya vienen como enteros.
    """

    # -------------- BOOL GPR --------------
    # left_enabled / right_enabled: 0 / 1
    set_output_register_bit(GPR_BOOL_LEFT_ENABLED,  left_enabled)
    set_output_register_bit(GPR_BOOL_RIGHT_ENABLED, right_enabled)

    # -------------- INT GPR ---------------
    set_output_register_int(GPR_INT_SIDE_CODE,      side_code)
    set_output_register_int(GPR_INT_LEFT_LAYER,     left_layer)
    set_output_register_int(GPR_INT_LEFT_SLOT,      left_slot)
    set_output_register_int(GPR_INT_RIGHT_LAYER,    right_layer)
    set_output_register_int(GPR_INT_RIGHT_SLOT,     right_slot)


def main():
    """
    Punto de entrada del script cuando se llama desde el HMI.

    Los argumentos llegan como sys.argv:
      sys.argv[0] → nombre del script
      sys.argv[1] → side_code
      sys.argv[2] → left_enabled
      sys.argv[3] → left_layer
      sys.argv[4] → left_slot
      sys.argv[5] → right_enabled
      sys.argv[6] → right_layer
      sys.argv[7] → right_slot
    """
    argv = sys.argv

    if len(argv) < 8:
        # Faltan argumentos; no hacemos nada peligroso
        # Puedes dejar un tp_log aquí si quisieras debuguear
        return

    # Convertir todos los argumentos (str) a int
    side_code      = int(argv[1])
    left_enabled   = int(argv[2])
    left_layer     = int(argv[3])
    left_slot      = int(argv[4])
    right_enabled  = int(argv[5])
    right_layer    = int(argv[6])
    right_slot     = int(argv[7])

    # Enviar a los GPR
    send_pallet_config_to_plc(
        side_code,
        left_enabled,
        left_layer,
        left_slot,
        right_enabled,
        right_layer,
        right_slot,
    )

    # Breve espera opcional
    wait(0.05)



main()
